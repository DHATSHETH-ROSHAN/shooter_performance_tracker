{% extends 'base.html' %}
{% load static %}

{% block title %}
Shooter's Home
{% endblock %}
{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<link rel="stylesheet" type="text/css" href="{% static 'css/shooterhome.css' %}">

{% endblock %}
{% block content %}
{% include 'navbar.html' %}

<div class="container-fluid mt-4">
    <div class="row">
    <!--Left column(profile holder)-->
    <div class="col-lg-3 col-md-4 col-sm-12 mb-4" style="size: auto-fit;" >
        <div style="background-color: #050505; padding: 10px; border-radius: 10px; height: 100%; margin-bottom: 10px;">
            <div class="card text-white shadow-sm" style="background-color: #050505;" >
                <div class="card-body text-white text-center">
                    <img src="{% static 'images/shooter.jpg' %}" alt="Profile Pic" class="rounded-circle" width="80" height="80">
                    <h4 class="mt-2">Welcome, {{ user.first_name }}ðŸŽ¯</h4>
                    <p class="logo_txt">{{ user.role }}</p>
                    <button class="btn btn-sm btn-info mt-2" onclick="toggleProfile()">View Profile</button>
                    <hr>
                    <p>{{ user.description }}</p>
                    <div class="col">
                        <div class="row">
                            <div class="col-6">
                                <h6>Last session</h6>
                                <p class="fw-bold">{{ last_session|date:"d.m.Y" }}</p>
                            </div>
                            <div class="col-6">
                                <h6>Session duration</h6>
                                <p class="fw-bold">{{ session_timing }} </p>
                            </div>
                        </div>
                    </div>
                    <hr>
                </div>
            </div>
            <!-- Panel contents -->
            <div class="card" style="background-color: #050505;">
                <div class="card-body text-white text-center">
                    <h5 class="card-title">Training categories</h5>
                    <button class="btn btn-sm btn-info mb-2" onclick="showContent('shooting')">Shooting</button>
                    <button class="btn btn-sm btn-info mb-2" onclick="showContent('workout')">Workout</button>
                    <button class="btn btn-sm btn-info mb-2" onclick="showContent('meditation')">Meditation</button>
                    <button class="btn btn-sm btn-info mb-2" onclick="showContent('equipment')">Equipment</button>
                </div>
                <div class="card-body text-white">
                    <div id="shooting" class="training-content">
                        <h5>Shooting session</h5>
                        <p>Track your shooting practice and analyze your performance</p>
                        <h4 class="text-center">Monthly Practice Tracker <br> {{ current_month }}/{{ current_year }}</h4>
                        <div class="calendar" id="calendar_shooting"></div>
                    </div>
                    <div id="workout" class="training-content" style="display: none;" >
                        <h5>Workout session</h5>
                        <p>Monitor your fitness and strength training for better stability.</p>
                        <h4 class="text-center">Workouts sessions</h4>
                        <div class="calendar" id="calendar_workout"></div>
                    </div>
                    <div id="meditation" class="training-content" style="display: none;">
                        <h5>Meditation & Focus</h5>
                        <p>Improve your concentration and mental clarity for shooting.</p>
                        <div class="calendar" id="calendar_meditation"></div>
                    </div>
                    <div id="equipment" class="training-content" style="display: none;">
                        <h5>Equipment Maintenance</h5>
                        <p>Keep track of your rifle maintenance and adjustments.</p>
                        <div class="calendar" id="equipment_calendar"></div>
                    </div>
                </div>
            </div>
            <div>
                <div class="card-body text-white text-center">
                    <button onclick="window.location.href='{% url 'history' %}';" class="btn btn-info">
                        <b>Go to Shooter History</b>
                    </button>                    
                </div>
            </div>
        </div>
    </div>
    <!-- center column(stats holder & some perfomance ) -->
     <div class="col-lg-6 col-md-8 col-sm-12 mb-4" style="background-color: #050505; padding: 10px; border-radius: 10px;">
        <div class="card text-white" style="background-color: #050505;">
            <div class="card-body">
                <h5 class="card-title logo_txt text-center"> Performance Overview</h5>
                <br>
                <div class="row text-center">
                    <div class="col-4">
                        <h6>Total Session</h6>
                        <div class="row">
                        <div class="col-6">
                            <p>40 shots</p>    
                            <p class="fw-bold text-success">{{ total_session_40 }}</p>
                        </div>
                        <div class="col-6">
                            <p>60 shots</p>    
                            <p class="fw-bold text-success">{{ total_session_60 }}</p>
                        </div>
                        </div>
                    </div>
                    <div class="col-4">
                        <h6>Best Score</h6>
                        <div class="row">
                        <div class="col-6">
                            <p>40 shots</p>    
                            <p class="fw-bold text-success">{{ best_score_40 }}</p>
                        </div>
                        <div class="col-6">
                            <p>60 shots</p>    
                            <p class="fw-bold text-success">{{ best_score_60 }}</p>
                        </div>
                        </div>
                    </div>
                    <div class="col-4">
                        <h6>30 Days Average</h6>
                        <div class="row">
                            <div class="col-6">
                                <p>40 shots</p>    
                                <p class="fw-bold text-success">{{ avg_score_40 }}</p>
                            </div>
                            <div class="col-6">
                                <p>60 shots</p>    
                                <p class="fw-bold text-success">{{ avg_score_60 }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <hr style="color:white;">
        <!--profile container -->
        <div id="profileContainer" class="container-fluid text-white shadow-sm" style="background-color: #050505; display: none;">
            <div class="container-fluid py-5">
                <div style="width: 100%; margin: auto; padding:2px; background-color: #050505; border-radius: 10px;">
                    <div class="d-flex justify-content-between align-items-center">
                        <h2 style="color: #00DDFF; text-align: left; margin-bottom: 20px;">Shooter Profile</h2>
                        <button onclick="document.getElementById('profileContainer').style.display='none';" class="btn-close btn-close-white"></button>
                    </div>
                    <div class="row">
                        <!-- Profile Image & Name -->
                        <div class="col-4 py-4 text-center">
                            <i class="fas fa-user-circle" style="font-size: 120px; color: #00DDFF;"></i>
                            <h4 style="color: #00DDFF; margin-top: 10px;"><i class="bi bi-person"></i> {{ user.username }}</h4>
                            <p style="color: grey;"><i class="bi bi-calendar3"></i> Age: {{ age }} / {{ user.category }} </p>
                            <p style="color: grey;"><i class="bi bi-gender-ambiguous"></i> Gender: {{ user.gender }}</p>
                            <div class="py-3">
                                <button class="btn btn-info" data-bs-toggle="modal" data-bs-target="#editProfileModal" style="background-color: #00DDFF; border: none; padding: 8px 15px; border-radius: 5px; color: black; font-weight: bold; cursor: pointer; margin-top: 10px;">
                                    <i class="bi bi-pencil"></i> Edit
                                </button>
                            </div>
                        </div>
                        <!-- Contact Info -->
                        <div class="col-4 py-5">
                            <p style="margin-bottom: 15px; font-size: 16px;">
                                <strong style="color: #00DDFF; font-size:18px; margin-right: 2px;">
                                    <i class="bi bi-envelope-paper" style="margin-right: 2px;"></i>Email:
                                </strong> <span style="color: white;">{{ user.email }}</span>
                            </p>
                            <p style="margin-bottom: 15px; font-size: 16px;">
                                <strong style="color: #00DDFF; font-size:18px; margin-right: 4px;">
                                    <i class="bi bi-telephone" style="margin-right: 4px;"></i> Phone:
                                </strong> <span style="color: white;">{{ user.mobile_number }}</span>
                            </p>
                            <p style="margin-bottom: 15px; font-size: 16px;">
                                <strong style="color: #00DDFF; font-size:18px; margin-right: 4px;">
                                    <i class="bi bi-calendar-event" style="margin-right: 4px;"></i> DOB:
                                </strong> <span style="color: white;">{{ user.date_of_birth }}</span>
                            </p>
                        </div>
        
                        <!-- Shooting Stats -->
                        <div class="col-4 py-5">
                            <p style="margin-bottom: 15px; font-size: 16px;">
                                <strong style="color: #00DDFF; font-size:18px; margin-right: 4px;">
                                    <i class="bi bi-bullseye" style="margin-right: 4px;"></i> Total Matches:
                                </strong> <span style="color: white;">{{ overallsessions }}</span>
                            </p>
                            <p style="margin-bottom: 15px; font-size: 16px;">
                                <strong style="color: #00DDFF; font-size:18px; margin-right: 4px;">
                                    <i class="bi bi-graph-up-arrow" style="margin-right: 4px;"></i> Best(40/60) :
                                </strong> <span style="color: white;">{{ best_score_40 }}/{{ best_pdf_60_shots }} </span>
                            </p>
                            <p style="margin-bottom: 15px; font-size: 16px;">
                                <strong style="color: #00DDFF; font-size:18px; margin-right: 4px;">
                                    <i class="bi bi-bar-chart" style="margin-right: 4px;"></i> Affiliated club:
                                </strong> <span style="color: white;">{{ user.affiliated_club }}</span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            <hr>
        </div>
        <!-- messages thing -->
        <div id="messagesContainer" class="container-fluid text-white shadow-sm" style="background-color: #050505; display: none;">
            <div class="container-fluid py-5">
                <div style="width: 100%; margin: auto; padding: 2px; background-color: #050505; border-radius: 10px;">
                    <div class="d-flex justify-content-between align-items-center">
                        <h2 style="color: #00DDFF; text-align: left; margin-bottom: 20px;">Messages</h2>
                        <button onclick="document.getElementById('messagesContainer').style.display='none';" class="btn-close btn-close-white"></button>
                    </div>
                    {% if conversations %}
                    <div class="py-3">
                        <div class="row">
                            <!-- Conversation List -->
                            <div class="col-4">
                                {% for convo in conversations %}
                                    <div class="card p-3 mb-3 message-card open-chat" data-user-id="{{ convo.other_user.id }}" style="cursor: pointer; transition: background-color 0.3s;">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div class="d-flex align-items-center">
                                                <div class="avatar">
                                                    <span class="avatar-text">{{ convo.other_user.username|first|upper }}</span>
                                                </div>
                                                <span class="text-light ms-2 username"><b>{{ convo.other_user.username }}</b></span>
                                            </div>
                                            <div>
                                                <small style="color: #707070">{{ convo.last_message.timestamp|date:"H:i" }}</small>
                                                {% if convo.unread_count > 0 %}
                                                    <span class="badge bg-danger unread-badge">{{ convo.unread_count }}</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <p class="text-light mt-2 message-preview">{{ convo.last_message.content|truncatechars:50 }}</p>
                                    </div>
                                {% endfor %}
                            </div>

                            <!-- Chat Window (Will be loaded dynamically) -->
                            <div class="col-8">
                                <div id="chat-window" class="chat-box">
                                    <p class="text-light text-center">Select a chat to start messaging</p>
                                </div>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <p class="text-center">No messages yet.</p>
                {% endif %}
                </div>
            </div>
            <hr>
        </div>
          
        <!-- chart -->
        <div id="middleChartContainer" class="card mt-4" style="background-color: #050505;">
            <div class="card-body">
                <div id="weeklyChart">
                </div>
            </div>
        </div>
    </div>
    <!-- Riglt colum(traing activities) -->
         <div class="col-lg-3 col-md-4 col-sm-12 mb-4">
            <div style="background-color: #050505; padding: 10px; height: 100%; border-radius: 10px;">
                <div class="card text-white shadow-sm" style="background-color: #020202;">
                    <div class="card-body text-center">
                        <h5 class="card-title">ðŸ”¥ Streaks</h5>
                        <p class="fw-bold">Current Streak:<span id="streakDays">{{ streak_count }}</span>Days</p>
                        <div class="progress" style="height: 5px;">
                            <div id="streakProgress" class="progress-bar bg-warning" role="progressbar" style="width: 0%;" aria-valuemin="0" aria-valuemax="30"></div>
                        </div>
                        <small>Maintain your streaks to score more.</small>
                    </div>
                    <hr>
                    <div>
                        <div class="align-center">
                            <h5 class= "text-info">My Coach</h5>
                            <div class="d-flex justify-content-around">
                                {% if coach_relation %}
                                <p style="font-size:20px;"><strong> Coach:</strong> {{ coach_relation.coach.username }} </p>
                                <div> 
                                <button class="btn btn-info btn-sm" type="button" data-bs-toggle="modal" data-bs-target="#coachProfileModal">
                                    View Profile
                                </button>
                            </div>
                                {% else %}
                            </div>
                            <p>You dont have a coach assigned yet !.</p>
                            {% comment %} select coach button {% endcomment %}
                            <button class="btn btn-info btn-sm" type="button" data-bs-toggle="modal" data-bs-target="#selectcoachModal">
                                Select coach
                            </button>
                            {% endif %}
                        </div>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-around">
                        <button class="btn btn-info btn-sm" onclick="openPopup('notificationsPopup')">ðŸ”” Notifications</button>
                        <button class="btn btn-sm btn-info mt-2" onclick="toggleMessages()">ðŸ’¬ Messages</button>
                    </div>
                    <!-- Coach Profile Modal -->
                    <div class="modal fade" id="coachProfileModal" tabindex="-1" aria-labelledby="coachProfileModalLabel" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content" style="background-color:#050505; border-radius:12px; width: 75%;">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="coachProfileModalLabel">Coach Profile</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <p><strong>Name:</strong> {{ coach_relation.coach.username }}</p>
                                    <p><strong>Total Shooters Trained:</strong> {{ current_shooters_count }}</p>
                                    <p><strong>Highest Student Score:</strong> {{ coach_relation.coach.highest_score }}</p>
                                </div>
                                <div class="modal-footer">
                                    <!-- Remove Coach Button -->
                                    <form method="POST" action="{% url 'remove_coach' %}">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-danger">Remove Coach</button>
                                    </form>
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% comment %} needs to hidden intially and it can open when needed {% endcomment %}
                    {% if not coach_relation %}
                    <div class="modal fade" id="selectcoachModal" tabindex="-1" aria-labelledby="selectcoachModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content" style="background-color:#050505; border-radius:12px;">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="selectcoachModalLabel">Available Coaches</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <form method="POST" action="{% url 'select_coach_or_shooter' %}">
                                        {% csrf_token %}
                                        <label for="coach_id">Choose your Coach:</label>
                                        <select name="coach_id" class="form-control text-light" style="background-color: #202020;">
                                            {% for coach in coaches %}
                                                <option value="{{ coach.id }}">{{ coach.username }}</option>
                                            {% empty %}
                                                <option disabled>No coaches available</option>
                                            {% endfor %}
                                        </select>
                                        <br>
                                        <button type="submit" class="btn btn-success">Send Request</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    <hr>
                    <div class="card-body text-center">
                        <h5 class="card-title">Training & Activities</h5>
                        <br>
                        <div class="row">
                            <a href="{% url 'manual_upload' %}" class="btn btn-danger btn-sm mb-2">Manually Upload Score</a>
                            <a href="{% url 'pdf_upload' %}" class="btn btn-success btn-sm mb-2">Upload Pdf (EST Score)</a>
                        </div>
                        <br>
                        <a href="{% url 'activities' %}" class="btn btn-primary btn-sm">Activities</a>
                    </div>
                    <!-- for 40 shots -->
                    <div class="card-body text-center" id="goalTracker40Container">
                        <h5 class="card-title logo_txt">ðŸŽ¯ Goal Tracker</h5>
                        <p>Current Score:<span id="currentscore">{{ current_score_40 }}</span>/ Target Score: <span id="targetscore">{{ target_score_40 }}</span></p>
                        <div id="goalTrackerChart40">
                            
                        </div>
                        <p  class="mt-2"><b>Progress: <span id="progressPercentage40"></span></b></p>
                    </div>
                    <!-- for 60 shots -->
                    <div class="card-body text-center" id="goalTracker60Container">
                        <h5 class="card-title logo_txt">ðŸŽ¯ Goal Tracker</h5>
                        <p>Current Score:<span id="currentscore">{{ current_score_60 }}</span>/ Target Score: <span id="targetscore">{{ target_score_60 }}</span></p>
                        <div id="goalTrackerChart60">
                            
                        </div>
                        <p  class="mt-2"><b>Progress: <span id="progressPercentage60"></span></b></p>
                    </div>
                    <div id="notificationsPopup" class="popup">
                        <div class="popup-content">
                            <span class="close" onclick="closePopup('notificationsPopup')">&times;</span>
                            <h5>Notifications</h5>
                            <ul class="list-group">
                                <li class="list-group-item">Your coach Commented on your session!</li>
                                <li class="list-group-item">New training module available.</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
         </div>
     </div>
    </div>
    <!-- modal edit profile-->
    <div class="modal fade" id="editProfileModal" tabindex="-1" aria-labelledby="editProfileModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content text-light" style="background-color: #050505;border: 2px solid #00ddff;">
                <div class="modal-header">
                    <h5 class="modal-title text-info" id="editProfileModalLabel">Edit Profile</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form method="POST" action="{% url 'update_profile' %}">
                        {% csrf_token %}
                        <div class="form-group">
                            <label for="edit-coach-name">Name</label>
                            <input type="text" id="edit-coach-name" name="name" class="form-control" value="{{ user.username|default:'' }}" required>
                        </div>
                        <div class="form-group mt-2">
                            <label for="edit-coach-email">Email</label>
                            <input type="email" id="edit-coach-email" name="email" class="form-control" value="{{ user.email|default:'' }}" required>
                        </div>
                        <div class="form-group mt-2">
                            <label for="edit-coach-mobile_number">Mobile No.</label>
                            <input type="phone" id="edit-coach-mobile_number" name="mobile_number" class="form-control" value="{{ user.mobile_number|default:'' }}" required>
                        </div>
                        <div class="form-group mt-2">
                            <label for="edit-coach-dob">Date of Birth</label>
                            <input type="date" id="edit-coach-dob" name="dob" class="form-control" value="{{ user.date_of_birth|date:'Y-m-d' }}" required>
                        </div>
                        <div class="form-group mt-2">
                            <label for="edit-coach-gender">Gender</label>
                            <select id="edit-coach-gender" name="gender" class="form-control" required>
                                <option value="Male" {% if gender == "Male" %}selected{% endif %}>Male</option>
                                <option value="Female" {% if gender == "Female" %}selected{% endif %}>Female</option>
                                <option value="Other" {% if gender == "Other" %}selected{% endif %}>Other</option>
                            </select>
                        </div>
                        <div class="form-group mt-2">
                            <label for="edit-coach-club">Affiliated Club/Academy</label>
                            <input type="text" id="edit-coach-club" name="club" class="form-control" value="{{ user.affiliated_club|default:'' }}" required>
                        </div>
                        <button type="submit" class="btn btn-info mt-3">Save Changes</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>

    // charts dipalayed inn the center of the page
var dataSeries = [{{ avg_dur_sun }}, {{ avg_dur_mon }}, {{ avg_dur_tue }}, {{ avg_dur_wed }}, {{ avg_dur_thu }}, {{ avg_dur_fri }}, {{ avg_dur_sat }}];

// Check if all values are 0
if (dataSeries.every(value => value === 0)) {
    document.querySelector("#weeklyChart").innerHTML = `<div style="color: #ffffff; text-align: center; font-size: 16px; font-weight: bold; padding: 20px;">
        No practice data available for this week.
    </div>`;
} else {
    var options = {
        chart: {
            type: 'bar'
        },
        title: {
            text: "Average Practice Time Per Day",
            align: 'center',
            style: {
                fontSize: '16px',
                fontWeight: 'bold',
                color: '#ffffff'
            }
        },
        plotOptions: {
            bar: {
                horizontal: false,
                columnWidth: '50%'    
            }
        },
        xaxis: {
            title: {
                text: 'Days of the Week',
                style: {
                    fontSize: '14px',
                    fontWeight: 'bold',
                    color: '#ffffff'
                }
            },
            categories: ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'], 
            labels: {
                style: {
                    colors: '#ffffff'
                }
            }
        },
        yaxis: {
            title: {
                text: 'Avg. Practice Time (minutes)',
                style: {
                    fontSize: '14px',
                    fontWeight: 'bold',
                    color: '#ffffff'
                }
            },
            labels: {
                style: {
                    colors: '#ffffff'
                }
            }
        },
        series: [
            {
                name: 'Average Time',
                data: dataSeries
            }
        ],
        colors: ['#00ddff'],
        grid: {
            borderColor: '#444'
        }
    };

    var chart = new ApexCharts(document.querySelector("#weeklyChart"), options);
    chart.render();
}

// streak progress
document.addEventListener("DOMContentLoaded", function () {
    let streakCount = parseInt("{{ streak_count }}", 10);
    let maxStreak = 30;  // You can adjust this limit
    let progressPercentage = (streakCount / maxStreak) * 100;

    document.getElementById("streakProgress").style.width = progressPercentage + "%";
    document.getElementById("streakProgress").setAttribute("aria-valuenow", streakCount);
});

// show and hide the taabs in the rigth side panel  
function showContent(section) {
    document.querySelectorAll('.training-content').forEach(el => el.style.display = 'none');
    let content = document.getElementById(section.toLowerCase());
    if (content) {
        content.style.display = 'block';
    }
};

function toggleProfile() {
    var profileContainer = document.getElementById("profileContainer");

    if (profileContainer.classList.contains("show-profile")) {
        profileContainer.classList.remove("show-profile");
        setTimeout(() => {
            profileContainer.style.display = "none";
        }, 300); // Matches the CSS transition duration
    } else {
        profileContainer.style.display = "block";
        setTimeout(() => {
            profileContainer.classList.add("show-profile");
        }, 10); // Small delay to trigger transition
    }
};

function toggleMessages() {
    var messageContainer = document.getElementById("messagesContainer");

    if (messageContainer.classList.contains("show-profile")) {
        messageContainer.classList.remove("show-profile");
        messageContainer.classList.add("hide-profile");
        setTimeout(() => {
            messageContainer.style.display = "none";
        }, 300);
    } else {
        messageContainer.style.display = "block";
        setTimeout(() => {
            messageContainer.classList.add("show-profile");
            messageContainer.classList.remove("hide-profile");
        }, 10);
    }
};


// goal tracker
// goal tracker chrt 40
// Update the progress text
let currentScore_40 = parseInt('{{ current_score_40 }}');
let targetScore_40 = parseInt('{{ target_score_40 }}');
var progress = (currentScore_40 / targetScore_40) * 100;
progress = progress > 100 ? 100 : progress;

document.getElementById("progressPercentage40").innerText = progress.toFixed(1);

var goalTrackerOptions40 = {
    series: [progress],
    chart: {
        height: 250,
        type: "radialBar"
    },
    plotOptions: {
        radialBar: {
            startAngle: -90,
            endAngle: 90,
            track: {
                background: "#333",
                strokeWidth: "90%"
            },
            dataLabels: {
                name: {
                    show: false
                },
                value: {
                    offsetY: 5,
                    fontSize: "22px",
                    color: "#ffffff",
                    formatter: function (val) {
                        return val.toFixed(1) + "%";
                    }
                }
            }
        }
    },
    fill: {
        colors: ["#00ddff"]
    },
    stroke: {
        lineCap: "round"
    },
    labels: ["Progress"]
};

var goaltrackerChart40 = new ApexCharts(document.querySelector("#goalTrackerChart40"), goalTrackerOptions40);
goaltrackerChart40.render();


// goal tracker chart 60
// Update the progress text
let currentScore60 = parseInt('{{ current_score_60 }}');
let targetScore60 = parseInt('{{ target_score_60 }}');
var progress = (currentScore60 / targetScore60) * 100;
progress = progress > 100 ? 100 : progress;
document.getElementById("progressPercentage60").innerText = progress.toFixed(1);

var goalTrackerOptions60 = {
    series: [progress],
    chart: {
        height: 250,
        type: "radialBar"
    },
    plotOptions: {
        radialBar: {
            startAngle: -90,
            endAngle: 90,
            track: {
                background: "#333",
                strokeWidth: "90%"
            },
            dataLabels: {
                name: {
                    show: false
                },
                value: {
                    offsetY: 5,
                    fontSize: "22px",
                    color: "#ffffff",
                    formatter: function (val) {
                        return val.toFixed(1) + "%";
                    }
                }
            }
        }
    },
    fill: {
        colors: ["#00ddff"]
    },
    stroke: {
        lineCap: "round"
    },
    labels: ["Progress"]
};

var goalTrackerChart60 = new ApexCharts(document.querySelector("#goalTrackerChart60"), goalTrackerOptions60);
goalTrackerChart60.render();

document.addEventListener("DOMContentLoaded", function () {
    let lastMatchType = "{{ last_match_type }}";
    let goalTracker40 = document.getElementById("goalTracker40Container");
    let goalTracker60 = document.getElementById("goalTracker60Container");

    if (lastMatchType == "60-Shots") {
        goalTracker40.style.display = "none";
        goalTracker60.style.display = "block";
    } else {
        goalTracker40.style.display = "block";
        goalTracker60.style.display = "none";
    }
});

// popup messages and notification thing
function openPopup(id) {
    document.getElementById(id).style.display = "block";
}
function closePopup(id) {
    document.getElementById(id).style.display = "none";
}

const practiceDays = JSON.parse('{{ practice_days|safe }}'); 
const workoutdates = JSON.parse('{{ workoutdates|safe }}');
const meddays = JSON.parse('{{ medidates|safe }}');
const equidays = JSON.parse('{{ equipmaindays|safe }}');
const currentYear = {{ current_year }};
const currentMonth = {{ current_month }};

function generateCalendar(containerId, year, month, practiceDays = []) {
    const calendar = document.getElementById(containerId);
    if (!calendar) {
        console.error(`Element with ID '${containerId}' not found.`);
        return;
    }
    
    calendar.innerHTML = ""; // Clear previous content

    const firstDay = new Date(year, month - 1, 1);
    const lastDay = new Date(year, month, 0).getDate();
    const startDay = firstDay.getDay(); // 0 = Sunday, 1 = Monday...

    // Add empty cells for first week
    for (let i = 0; i < startDay; i++) {
        const emptyCell = document.createElement("div");
        emptyCell.classList.add("day");
        calendar.appendChild(emptyCell);
    }

    // Fill in the dates
    for (let date = 1; date <= lastDay; date++) {
        const dayCell = document.createElement("div");
        dayCell.classList.add("day");
        dayCell.innerText = date;

        const formattedDate = `${year}-${String(month).padStart(2, '0')}-${String(date).padStart(2, '0')}`;
        if (practiceDays.includes(formattedDate)) {
            dayCell.classList.add("practice-day"); // Highlight practiced days
        }

        calendar.appendChild(dayCell);
    }
};

generateCalendar("calendar_shooting", currentYear, currentMonth, practiceDays);
generateCalendar("calendar_workout", currentYear, currentMonth, workoutdates);
generateCalendar("calendar_meditation", currentYear, currentMonth, meddays);
generateCalendar("equipment_calendar", currentYear, currentMonth, equidays);

{% comment %} connect chats scripts {% endcomment %}
document.querySelectorAll(".open-chat").forEach(button => {
    button.addEventListener("click", function() {
        const userId = this.getAttribute("data-user-id");
        const chatWindow = document.getElementById("chat-window");
        const conversationId = [userId, '{{ request.user.id }}'].sort().join('_');
        
        // Remove active class from all cards and add to current
        document.querySelectorAll('.message-card').forEach(card => {
            card.classList.remove('active');
        });
        this.classList.add('active');
        
        // Mark messages as read in backend
        fetch(`/message/messages/read/${conversationId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            }
        })
        .then(response => response.json())
        .then(data => {
            // Hide unread badge when messages are marked as read
            const unreadBadge = this.querySelector('.unread-badge');
            if (unreadBadge) {
                unreadBadge.style.display = 'none';
            }
        })
        .catch(error => console.error('Error marking messages as read:', error));
        
        // Load chat content
        fetch(`/message/chat/${userId}/`)
            .then(response => response.text())
            .then(data => {
                chatWindow.innerHTML = data;
                
                // Scroll to bottom of messages after loading chat
                const messagesDiv = document.getElementById('chat-messages');
                if (messagesDiv) {
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                }
                
                // Initialize WebSocket connection
                const chatSocket = new WebSocket(
                    'ws://' + window.location.host + '/ws/chat/' + conversationId + '/'
                );

                chatSocket.onopen = function(e) {
                    console.log('WebSocket connection established');
                };

                chatSocket.onmessage = function(e) {
                    console.log('Received message:', e.data);
                    const data = JSON.parse(e.data);
                    
                    // Get the messages container
                    const messagesDiv = document.getElementById('chat-messages');
                    if (!messagesDiv) {
                        console.error('Messages container not found');
                        return;
                    }

                    // Create new message element
                    const messageDiv = document.createElement('div');
                    messageDiv.className = data.sender === '{{ request.user.username }}' ? 'sent-message' : 'received-message';
                    
                    // Format the timestamp
                    const timestamp = new Date(data.timestamp);
                    const formattedTime = timestamp.toLocaleTimeString('en-US', { 
                        hour: '2-digit', 
                        minute: '2-digit',
                        hour12: false 
                    });
                    
                    // Set message content
                    messageDiv.innerHTML = `
                        <p>${data.message}</p>
                        <small class="text-muted">${formattedTime}</small>
                    `;
                    
                    // Append message and scroll to bottom
                    messagesDiv.appendChild(messageDiv);
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;

                    // If this is a received message and chat is active, mark it as read
                    if (data.sender !== '{{ request.user.username }}' && this.classList.contains('active')) {
                        fetch(`/message/messages/read/${conversationId}/`, {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                            }
                        }).catch(error => console.error('Error marking message as read:', error));
                    }
                };

                chatSocket.onerror = function(e) {
                    console.error('WebSocket error:', e);
                };

                chatSocket.onclose = function(e) {
                    console.error('WebSocket connection closed:', e);
                    // Attempt to reconnect after a delay
                    setTimeout(() => {
                        console.log('Attempting to reconnect...');
                        const newSocket = new WebSocket(
                            'ws://' + window.location.host + '/ws/chat/' + conversationId + '/'
                        );
                        // Copy over the event handlers to the new socket
                        newSocket.onopen = chatSocket.onopen;
                        newSocket.onmessage = chatSocket.onmessage;
                        newSocket.onerror = chatSocket.onerror;
                        newSocket.onclose = chatSocket.onclose;
                        chatSocket = newSocket;
                    }, 3000);
                };

                // Set up message sending
                const messageInput = document.querySelector('#chat-message-input');
                const sendButton = document.querySelector('#chat-message-send');

                function sendMessage() {
                    const message = messageInput.value.trim();
                    if (message && chatSocket.readyState === WebSocket.OPEN) {
                        const messageData = {
                            'message': message,
                            'sender_id': '{{ request.user.id }}',
                            'receiver_id': userId,
                            'conversation_id': conversationId
                        };
                        console.log('Sending message:', messageData);
                        chatSocket.send(JSON.stringify(messageData));
                        messageInput.value = '';
                    }
                }

                if (sendButton) {
                    sendButton.onclick = sendMessage;
                }

                if (messageInput) {
                    messageInput.onkeyup = function(e) {
                        if (e.keyCode === 13) {  // enter, return
                            sendMessage();
                        }
                    };
                }
            })
            .catch(error => console.error("Error loading chat:", error));
    });
});

// Keep track of active WebSocket connections
let activeWebSockets = {};

// Function to establish WebSocket connections for all chats
function connectAllChats() {
    document.querySelectorAll(".message-card").forEach(card => {
        const userId = card.getAttribute("data-user-id");
        if (!activeWebSockets[userId]) {
            const socket = new WebSocket(
                'ws://' + window.location.host + '/ws/chat/' + userId + '/'
            );

            socket.onmessage = function(e) {
                const data = JSON.parse(e.data);
                
                // Update unread badge for the conversation
                if (data.sender !== '{{ request.user.username }}') {
                    const conversationCard = document.querySelector(`.message-card[data-user-id="${userId}"]`);
                    if (conversationCard) {
                        // Only update badge if chat is not active
                        if (!conversationCard.classList.contains('active')) {
                            const unreadBadge = conversationCard.querySelector('.unread-badge');
                            if (unreadBadge) {
                                const currentCount = parseInt(unreadBadge.textContent) || 0;
                                unreadBadge.textContent = currentCount + 1;
                                unreadBadge.style.display = 'inline';
                            }
                        }

                        // If this chat is currently open, append the message
                        const messagesDiv = document.getElementById('chat-messages');
                        if (messagesDiv && conversationCard.classList.contains('active')) {
                            const messageDiv = document.createElement('div');
                            messageDiv.className = 'received-message';
                            
                            const timestamp = new Date(data.timestamp);
                            const formattedTime = timestamp.toLocaleTimeString('en-US', { 
                                hour: '2-digit', 
                                minute: '2-digit',
                                hour12: false 
                            });
                            
                            messageDiv.innerHTML = `
                                <p>${data.message}</p>
                                <small class="text-muted">${formattedTime}</small>
                            `;
                            
                            messagesDiv.appendChild(messageDiv);
                            messagesDiv.scrollTop = messagesDiv.scrollHeight;
                        }
                    }
                }
            };

            socket.onerror = function(e) {
                console.error('WebSocket error:', e);
            };

            socket.onclose = function(e) {
                console.error('WebSocket connection closed:', e);
                delete activeWebSockets[userId];
                // Attempt to reconnect
                setTimeout(() => connectAllChats(), 3000);
            };

            activeWebSockets[userId] = socket;
        }
    });
}

// Connect to all chats when the page loads
document.addEventListener('DOMContentLoaded', connectAllChats);

</script>


    
{% include 'footer.html' %}
{% endblock %}